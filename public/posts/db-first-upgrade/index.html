<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The first time I upgraded a PostgresSQL database | lervag's blog</title><meta name=keywords content><meta name=description content="Upgrading a live PostgreSQL database in a Kubernetes environment can be a daunting task.
Earlier this year, I faced this exact challenge: migrating an important PostgreSQL 15 database to version 16.
As this was the first time I tackled an upgrade of this nature, I realized I would gain more from the experience by documenting it.
Additionally, I hope to share insights that might help others navigate similar upgrades.
Fortunately, I collaborated with a knowledgeable colleague who was already well-versed in both PostgreSQL database maintenance and Kubernetes.
His support was invaluable—thanks Robin!"><meta name=author content="Karl Yngve Lervåg"><link rel=canonical href=../../posts/db-first-upgrade/><link crossorigin=anonymous href=../../assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=../../favicon.ico><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=apple-touch-icon href=../../apple-touch-icon.png><link rel=mask-icon href=../../safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=../../posts/db-first-upgrade/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=lervag.github.io src=https://plausible.io/js/script.js></script><link rel=stylesheet href=../../css/custom.css><meta property="og:url" content="/posts/db-first-upgrade/"><meta property="og:site_name" content="lervag's blog"><meta property="og:title" content="The first time I upgraded a PostgresSQL database"><meta property="og:description" content="Upgrading a live PostgreSQL database in a Kubernetes environment can be a daunting task. Earlier this year, I faced this exact challenge: migrating an important PostgreSQL 15 database to version 16. As this was the first time I tackled an upgrade of this nature, I realized I would gain more from the experience by documenting it. Additionally, I hope to share insights that might help others navigate similar upgrades.
Fortunately, I collaborated with a knowledgeable colleague who was already well-versed in both PostgreSQL database maintenance and Kubernetes. His support was invaluable—thanks Robin!"><meta property="og:locale" content="en-uk"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-18T01:00:00+00:00"><meta property="article:modified_time" content="2025-08-18T01:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="The first time I upgraded a PostgresSQL database"><meta name=twitter:description content="Upgrading a live PostgreSQL database in a Kubernetes environment can be a daunting task.
Earlier this year, I faced this exact challenge: migrating an important PostgreSQL 15 database to version 16.
As this was the first time I tackled an upgrade of this nature, I realized I would gain more from the experience by documenting it.
Additionally, I hope to share insights that might help others navigate similar upgrades.
Fortunately, I collaborated with a knowledgeable colleague who was already well-versed in both PostgreSQL database maintenance and Kubernetes.
His support was invaluable—thanks Robin!"><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/posts/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "The first time I upgraded a PostgresSQL database",
      "item": "/posts/db-first-upgrade/"
    }
  ]
}
</script><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "The first time I upgraded a PostgresSQL database",
  "name": "The first time I upgraded a PostgresSQL database",
  "description": "Upgrading a live PostgreSQL database in a Kubernetes environment can be a daunting task. Earlier this year, I faced this exact challenge: migrating an important PostgreSQL 15 database to version 16. As this was the first time I tackled an upgrade of this nature, I realized I would gain more from the experience by documenting it. Additionally, I hope to share insights that might help others navigate similar upgrades.\nFortunately, I collaborated with a knowledgeable colleague who was already well-versed in both PostgreSQL database maintenance and Kubernetes. His support was invaluable—thanks Robin!\n",
  "keywords": [
    
  ],
  "articleBody": "Upgrading a live PostgreSQL database in a Kubernetes environment can be a daunting task. Earlier this year, I faced this exact challenge: migrating an important PostgreSQL 15 database to version 16. As this was the first time I tackled an upgrade of this nature, I realized I would gain more from the experience by documenting it. Additionally, I hope to share insights that might help others navigate similar upgrades.\nFortunately, I collaborated with a knowledgeable colleague who was already well-versed in both PostgreSQL database maintenance and Kubernetes. His support was invaluable—thanks Robin!\nNow, the plan was simple:\nTake a dump of the old database from the Kubernetes pod. Perform the upgrade locally. Upload the upgraded files to the Kubernetes pod. Update our deployment scripts to run with the upgraded database files. Preliminary Work To do this job, I needed both PostgreSQL 15, PostgreSQL 16, and kubectl installed on my system. Thus, having a tool like mise really comes in handy, as it makes it very easy to retrieve tools on demand1. For instance, to do some very quick initial testing, I did:\nmise shell postgres@15.5 initdb -D tmp pg_ctl start -D tmp pg_ctl stop -D tmp First try Spoiler alert: I needed two tries.\nDump of the old database I first tried performing a pg_basebackup against the old PostgreSQL server via port forwarding:\n# Port forward between local 5432 and remote kubectl port-forward service/my-db 5432 # Test that it works psql --host localhost --port 5432 --user postgres postgres # Take backup pg_basebackup --host localhost --port 5432 --user postgres -D dump -Fp -Xs -P --checkpoint fast As the docs explain, pg_basebackup is used to take a base backup of a running PostgreSQL database cluster. The backup is taken without affecting other clients of the database. It really feels like the natural tool here.\nHowever, the process failed with a “connection reset”-type error. It must be some issue with networking or buffering – it’s a bit unclear. I don’t remember the specifics of this failure, since I figured I could just copy the files manually. So, I next tried to copy the old database files with kubectl:\nkubectl cp my-service-db/my-db-pg15-0:/var/lib/postgresql/data/pgdata -c postgres db-old I tested that I could start a server with the dumped files locally:\nmise shell postgres@15.5 pg_ctl start -D db-old # failed first time! rm db-old/postmaster.pid pg_ctl start -D db-old # now it worked pg_ctl stop -D db-old It worked, except that I found I had to remove the postmaster.pid file before running pg_ctl start. This was necessary because I had copied the files from a running database server in which the postmaster.pid is present, and PostgreSQL won’t start if it is present.\nUpgrading the database locally To upgrade the database locally, I used pg_upgrade, like this:\n# Create a new DB that we will upgrade into mise use postgres@16.6 initdb -D db-new -U postgres # Upgrade pg_upgrade -d db-old -D db-new \\ -b /home/lervag/.local/share/mise/installs/postgres/15.5/bin \\ -B /home/lervag/.local/share/mise/installs/postgres/16.6/bin Then I copied the upgrade files back onto the Kubernetes pod:\nkubectl cp db-new my-service-db/my-db-pg15-0:/var/lib/postgresql/data/pgdata-new -c postgres Upgrading the deployment scripts Once the new files were in place, I went in and updated our deployment.yml. I upgraded to 16.6 and instructed it to start from pgdata-new.\nThis seemingly worked fine. However, I observed two things that were not working as expected:\nWhen I look in the logs, I saw messages like\nWARNING: database \"postgres\" has no actual collation version, but a version was recorded This happened because I performed the upgrade on a computer with glibc. The PostgreSQL server runs in Kubernetes on an Alpine Linux pod with musl libc.\nWhen I tried to test by deploying to an environment in our project, I encountered a connection error. This turned out to be due to settings in both pg_hba.conf and postgresql.conf in the old version that were not carried over during the upgrade. The problem was resolved by fixing the configuration.\nStill, it was not satisfying to have the warnings in our logs. And we decided to try again with a clean slate.\nSecond attempt Now with pg_dump The next idea was based on pg_dump, which is another utility for backing up a PostgreSQL database. According to the docs, it makes consistent backups even if the database is being used concurrently and it does not block other users. The main difference is that pg_dump only dumps a single database and it does not include global objects such as roles. Further, pg_dump extracts the database into an SQL script file, possible compressed and archived, while pg_basebackup creates a physical byte-for-byte backup of the entire database cluster’s files.\nSo, we created a new plan:\nUse pg_dump to obtain a logical backup.\nkubectl port-forward service/my-db 5432 pg_dump -C -U postgres -h localhost -p 5432 -Zgzip:9 --if-exists -c mydbname \u003e db15.sql.gz Create a new fresh StatefulSet with PostgreSQL 16.\nAdd missing users with correct passwords, as well as grants:\nCREATE USER user1 WITH PASSWORD 'user1'; CREATE USER user2 WITH PASSWORD 'user2'; GRANT CONNECT ON mydbname TO user1; GRANT CONNECT ON mydbname TO user2; This is necessary, because as mentioned above, pg_dump does not include global objects such as roles.\nRestore from the dump.\nkubectl port-forward service/my-db 5432 mise shell postgres@16.6 zcat db15.sql.gz | psql -U postgres -h localhost -p 5432 postgres -v ON_ERROR_STOP=1 I followed the plan, except I used kubectl cp to copy the dump into Kubernetes and then ran the psql command locally in the shell there. It worked fine!\nConclusions All in all, I found this work to be interesting and I learned a lot from doing it. The main things I want to remember:\nI should not create the new, updated database on a different system from where it will be running. Understanding the environment, such as library differences between systems, is crucial! pg_dump proved more reliable in our scenario compared to pg_basebackup, especially when dealing with different system architectures. Working alongside a knowledgeable colleague accelerated the learning process and helped navigate unexpected challenges. Overall, these insights not only facilitated a successful upgrade but also equipped me with strategies for future infrastructure challenges.\nAs a final remark, I should mention I just noticed docker-pgautoupgrade. It looks awesome, and I’ll definitely look into it the next time I need to do a PostgreSQL upgrade!\nSee also The tools that I love: mise-en-place for more reasons why I like mise! ↩︎\n",
  "wordCount" : "1057",
  "inLanguage": "en",
  "datePublished": "2025-08-18T01:00:00Z",
  "dateModified": "2025-08-18T01:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Karl Yngve Lervåg"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/db-first-upgrade/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "lervag's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=../../ accesskey=h title="lervag's blog (Alt + H)">lervag's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=../../about/ title=about><span>about</span></a></li><li><a href=../../publications/ title=publications><span>publications</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=../../>Home</a>&nbsp;»&nbsp;<a href=../../posts/>Posts</a></div><h1 class="post-title entry-hint-parent">The first time I upgraded a PostgresSQL database</h1><div class=post-meta><span title='2025-08-18 01:00:00 +0000 UTC'>2025-08-18</span>&nbsp;·&nbsp;1057 words&nbsp;·&nbsp;Karl Yngve Lervåg&nbsp;|&nbsp;<a href=https://github.com/lervag/lervag.github.io/tree/main/content/posts/db-first-upgrade.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>Upgrading a live PostgreSQL database in a Kubernetes environment can be a daunting task.
Earlier this year, I faced this exact challenge: migrating an important PostgreSQL 15 database to version 16.
As this was the first time I tackled an upgrade of this nature, I realized I would gain more from the experience by documenting it.
Additionally, I hope to share insights that might help others navigate similar upgrades.</p><p>Fortunately, I collaborated with a knowledgeable colleague who was already well-versed in both PostgreSQL database maintenance and Kubernetes.
His support was invaluable—thanks <a href=https://kaveland.no/>Robin</a>!</p><p>Now, the plan was simple:</p><ol><li>Take a dump of the old database from the Kubernetes pod.</li><li>Perform the upgrade locally.</li><li>Upload the upgraded files to the Kubernetes pod.</li><li>Update our deployment scripts to run with the upgraded database files.</li></ol><h2 id=preliminary-work>Preliminary Work<a hidden class=anchor aria-hidden=true href=#preliminary-work>#</a></h2><p>To do this job, I needed both PostgreSQL 15, PostgreSQL 16, and <a href=https://kubernetes.io/docs/reference/kubectl/><code>kubectl</code></a> installed on my system.
Thus, having a tool like <a href=https://mise.jdx.dev/><code>mise</code></a> really comes in handy, as it makes it very easy to retrieve tools on demand<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.
For instance, to do some very quick initial testing, I did:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mise shell postgres@15.5
</span></span><span class=line><span class=cl>initdb -D tmp
</span></span><span class=line><span class=cl>pg_ctl start -D tmp
</span></span><span class=line><span class=cl>pg_ctl stop -D tmp
</span></span></code></pre></div><h2 id=first-try>First try<a hidden class=anchor aria-hidden=true href=#first-try>#</a></h2><p>Spoiler alert: I needed two tries.</p><h3 id=dump-of-the-old-database>Dump of the old database<a hidden class=anchor aria-hidden=true href=#dump-of-the-old-database>#</a></h3><p>I first tried performing a <a href=https://www.postgresql.org/docs/current/app-pgbasebackup.html><code>pg_basebackup</code></a> against the old PostgreSQL server via port forwarding:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Port forward between local 5432 and remote</span>
</span></span><span class=line><span class=cl>kubectl port-forward service/my-db <span class=m>5432</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Test that it works</span>
</span></span><span class=line><span class=cl>psql --host localhost --port <span class=m>5432</span> --user postgres postgres
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Take backup</span>
</span></span><span class=line><span class=cl>pg_basebackup --host localhost --port <span class=m>5432</span> --user postgres -D dump -Fp -Xs -P --checkpoint fast
</span></span></code></pre></div><p>As the docs explain, <code>pg_basebackup</code> is used to take a base backup of a running PostgreSQL database cluster.
The backup is taken without affecting other clients of the database.
It really feels like the natural tool here.</p><p>However, the process failed with a &ldquo;connection reset&rdquo;-type error.
It must be some issue with networking or buffering – it&rsquo;s a bit unclear.
I don&rsquo;t remember the specifics of this failure, since I figured I could just copy the files manually.
So, I next tried to copy the old database files with <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl cp my-service-db/my-db-pg15-0:/var/lib/postgresql/data/pgdata -c postgres db-old
</span></span></code></pre></div><p>I tested that I could start a server with the dumped files locally:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mise shell postgres@15.5
</span></span><span class=line><span class=cl>pg_ctl start -D db-old <span class=c1># failed first time!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rm db-old/postmaster.pid
</span></span><span class=line><span class=cl>pg_ctl start -D db-old <span class=c1># now it worked</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pg_ctl stop -D db-old
</span></span></code></pre></div><p>It worked, except that I found I had to remove the <code>postmaster.pid</code> file before running <code>pg_ctl start</code>.
This was necessary because I had copied the files from a running database server in which the <code>postmaster.pid</code> is present, and PostgreSQL won&rsquo;t start if it is present.</p><h3 id=upgrading-the-database-locally>Upgrading the database locally<a hidden class=anchor aria-hidden=true href=#upgrading-the-database-locally>#</a></h3><p>To upgrade the database locally, I used <a href=https://www.postgresql.org/docs/current/pgupgrade.html><code>pg_upgrade</code></a>, like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Create a new DB that we will upgrade into</span>
</span></span><span class=line><span class=cl>mise use postgres@16.6
</span></span><span class=line><span class=cl>initdb -D db-new -U postgres
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Upgrade</span>
</span></span><span class=line><span class=cl>pg_upgrade -d db-old -D db-new <span class=se>\
</span></span></span><span class=line><span class=cl>  -b /home/lervag/.local/share/mise/installs/postgres/15.5/bin <span class=se>\
</span></span></span><span class=line><span class=cl>  -B /home/lervag/.local/share/mise/installs/postgres/16.6/bin
</span></span></code></pre></div><p>Then I copied the upgrade files back onto the Kubernetes pod:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl cp db-new my-service-db/my-db-pg15-0:/var/lib/postgresql/data/pgdata-new -c postgres
</span></span></code></pre></div><h3 id=upgrading-the-deployment-scripts>Upgrading the deployment scripts<a hidden class=anchor aria-hidden=true href=#upgrading-the-deployment-scripts>#</a></h3><p>Once the new files were in place, I went in and updated our <code>deployment.yml</code>.
I upgraded to 16.6 and instructed it to start from <code>pgdata-new</code>.</p><p>This seemingly worked fine.
However, I observed two things that were not working as expected:</p><ol><li><p>When I look in the logs, I saw messages like</p><pre tabindex=0><code>WARNING:  database &#34;postgres&#34; has no actual collation version, but
          a version was recorded
</code></pre><p>This happened because I performed the upgrade on a computer with <code>glibc</code>.
The PostgreSQL server runs in Kubernetes on an Alpine Linux pod with <code>musl libc</code>.</p></li><li><p>When I tried to test by deploying to an environment in our project, I encountered a connection error.
This turned out to be due to settings in both <code>pg_hba.conf</code> and <code>postgresql.conf</code> in the old version that were not carried over during the upgrade.
The problem was resolved by fixing the configuration.</p></li></ol><p>Still, it was not satisfying to have the warnings in our logs.
And we decided to try again with a clean slate.</p><h2 id=second-attempt>Second attempt<a hidden class=anchor aria-hidden=true href=#second-attempt>#</a></h2><h3 id=now-with-pg_dump>Now with pg_dump<a hidden class=anchor aria-hidden=true href=#now-with-pg_dump>#</a></h3><p>The next idea was based on <a href=https://www.postgresql.org/docs/current/app-pgdump.html><code>pg_dump</code></a>, which is another utility for backing up a PostgreSQL database.
According to the docs, it makes consistent backups even if the database is being used concurrently and it does not block other users.
The main difference is that <code>pg_dump</code> only dumps a single database and it does not include global objects such as roles.
Further, <code>pg_dump</code> extracts the database into an SQL script file, possible compressed and archived, while <code>pg_basebackup</code> creates a physical byte-for-byte backup of the entire database cluster&rsquo;s files.</p><p>So, we created a new plan:</p><ol><li><p>Use <code>pg_dump</code> to obtain a logical backup.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl port-forward service/my-db <span class=m>5432</span>
</span></span><span class=line><span class=cl>pg_dump -C -U postgres -h localhost -p <span class=m>5432</span> -Zgzip:9 --if-exists -c mydbname &gt; db15.sql.gz
</span></span></code></pre></div></li><li><p>Create a new fresh <code>StatefulSet</code> with PostgreSQL 16.</p></li><li><p>Add missing users with correct passwords, as well as grants:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>USER</span><span class=w> </span><span class=n>user1</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=n>PASSWORD</span><span class=w> </span><span class=s1>&#39;user1&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>USER</span><span class=w> </span><span class=n>user2</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=n>PASSWORD</span><span class=w> </span><span class=s1>&#39;user2&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>GRANT</span><span class=w> </span><span class=k>CONNECT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>mydbname</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>user1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>GRANT</span><span class=w> </span><span class=k>CONNECT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>mydbname</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>user2</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>This is necessary, because as mentioned above, <code>pg_dump</code> does not include global objects such as roles.</p></li><li><p>Restore from the dump.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl port-forward service/my-db <span class=m>5432</span>
</span></span><span class=line><span class=cl>mise shell postgres@16.6
</span></span><span class=line><span class=cl>zcat db15.sql.gz <span class=p>|</span> psql -U postgres -h localhost -p <span class=m>5432</span> postgres -v <span class=nv>ON_ERROR_STOP</span><span class=o>=</span><span class=m>1</span>
</span></span></code></pre></div></li></ol><p>I followed the plan, except I used <code>kubectl cp</code> to copy the dump into Kubernetes and then ran the <code>psql</code> command locally in the shell there.
It worked fine!</p><h2 id=conclusions>Conclusions<a hidden class=anchor aria-hidden=true href=#conclusions>#</a></h2><p>All in all, I found this work to be interesting and I learned a lot from doing it.
The main things I want to remember:</p><ul><li>I should not create the new, updated database on a <em>different</em> system from where it will be running.
Understanding the environment, such as library differences between systems, is crucial!</li><li><code>pg_dump</code> proved more reliable in our scenario compared to <code>pg_basebackup</code>, especially when dealing with different system architectures.</li><li>Working alongside a knowledgeable colleague accelerated the learning process and helped navigate unexpected challenges.</li></ul><p>Overall, these insights not only facilitated a successful upgrade but also equipped me with strategies for future infrastructure challenges.</p><p>As a final remark, I should mention I just noticed <a href=https://github.com/pgautoupgrade/docker-pgautoupgrade>docker-pgautoupgrade</a>.
It looks awesome, and I&rsquo;ll definitely look into it the next time I need to do a PostgreSQL upgrade!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>See also <a href=../../posts/mise>The tools that I love: mise-en-place</a> for more reasons why I like <code>mise</code>!&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share The first time I upgraded a PostgresSQL database on x" href="https://x.com/intent/tweet/?text=The%20first%20time%20I%20upgraded%20a%20PostgresSQL%20database&amp;url=%2fposts%2fdb-first-upgrade%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The first time I upgraded a PostgresSQL database on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fposts%2fdb-first-upgrade%2f&amp;title=The%20first%20time%20I%20upgraded%20a%20PostgresSQL%20database&amp;summary=The%20first%20time%20I%20upgraded%20a%20PostgresSQL%20database&amp;source=%2fposts%2fdb-first-upgrade%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The first time I upgraded a PostgresSQL database on reddit" href="https://reddit.com/submit?url=%2fposts%2fdb-first-upgrade%2f&title=The%20first%20time%20I%20upgraded%20a%20PostgresSQL%20database"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The first time I upgraded a PostgresSQL database on facebook" href="https://facebook.com/sharer/sharer.php?u=%2fposts%2fdb-first-upgrade%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The first time I upgraded a PostgresSQL database on whatsapp" href="https://api.whatsapp.com/send?text=The%20first%20time%20I%20upgraded%20a%20PostgresSQL%20database%20-%20%2fposts%2fdb-first-upgrade%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The first time I upgraded a PostgresSQL database on telegram" href="https://telegram.me/share/url?text=The%20first%20time%20I%20upgraded%20a%20PostgresSQL%20database&amp;url=%2fposts%2fdb-first-upgrade%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The first time I upgraded a PostgresSQL database on ycombinator" href="https://news.ycombinator.com/submitlink?t=The%20first%20time%20I%20upgraded%20a%20PostgresSQL%20database&u=%2fposts%2fdb-first-upgrade%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=../../>lervag's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>